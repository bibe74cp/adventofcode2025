
# version: "3.8"

services:
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2025-latest
    container_name: sql2025
    ports:
      - "1433:1433"
    environment:
      ACCEPT_EULA: "Y"
      # Use a strong password that meets SQL Server requirements (8+ chars, uppercase, lowercase, digits or symbols)
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd}
      # For GA builds use Developer; for preview images you may need Evaluation
      MSSQL_PID: "Developer"
      MSSQL_AGENT_ENABLED: "true"
    volumes:
      # Named volume for persistence
      - sql_data:/var/opt/mssql
      - aoc_data:/var/aoc
    healthcheck:
      # tools18 are secure-by-default; -No makes encryption optional for local checks
      test: ["CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P \"$MSSQL_SA_PASSWORD\" -No -Q \"SELECT 1\" || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30

  db-init:
    image: mcr.microsoft.com/mssql/server:2025-latest
    depends_on:
      sqlserver:
        condition: service_healthy
    environment:
      ACCEPT_EULA: "Y"
      MSSQL_SA_PASSWORD: ${MSSQL_SA_PASSWORD:-YourStrong!Passw0rd}
    volumes:
      - ./initdb:/init:ro
    entrypoint: ["/bin/bash", "-c"]
    # Run the setup script once and then exit
    command: "/opt/mssql-tools18/bin/sqlcmd -S sqlserver -U sa -P \"$MSSQL_SA_PASSWORD\" -No -i /init/setup.sql"

volumes:
  sql_data:
  aoc_data:
